const _0x3f95a2=_0x2249;(function(_0x2bef51,_0x42c14b){const _0x253ea1=_0x2249,_0x5bb9ea=_0x2bef51();while(!![]){try{const _0x5cc7ab=parseInt(_0x253ea1(0x98))/0x1+parseInt(_0x253ea1(0x79))/0x2+parseInt(_0x253ea1(0xb7))/0x3+-parseInt(_0x253ea1(0xb4))/0x4*(parseInt(_0x253ea1(0x99))/0x5)+parseInt(_0x253ea1(0xbf))/0x6+parseInt(_0x253ea1(0x83))/0x7*(parseInt(_0x253ea1(0x89))/0x8)+-parseInt(_0x253ea1(0xbc))/0x9;if(_0x5cc7ab===_0x42c14b)break;else _0x5bb9ea['push'](_0x5bb9ea['shift']());}catch(_0x568190){_0x5bb9ea['push'](_0x5bb9ea['shift']());}}}(_0x1706,0x2630c));import _0x608ea5 from'express';import _0x194d65 from'mongoose';import _0x2b6fc5 from'node-fetch';import _0x595b89 from'node-cron';function _0x2249(_0x457128,_0x4c078d){const _0x1706cc=_0x1706();return _0x2249=function(_0x22494c,_0xf73ea9){_0x22494c=_0x22494c-0x71;let _0x3158ae=_0x1706cc[_0x22494c];return _0x3158ae;},_0x2249(_0x457128,_0x4c078d);}import _0x2bc7b2 from'crypto';const app=_0x608ea5(),PORT=process[_0x3f95a2(0xb9)][_0x3f95a2(0x90)]||0xbb8,CHANNEL_ID=_0x3f95a2(0x8b);await _0x194d65[_0x3f95a2(0xa4)]('mongodb+srv://davekekv:C4kxK3SFZkLA2CZe@cluster0.wkodygj.mongodb.net/leaderboardDB?retryWrites=true&w=majority',{'useNewUrlParser':!![],'useUnifiedTopology':!![]});const messageSchema=new _0x194d65[(_0x3f95a2(0x75))]({'username':{'type':String,'unique':!![]},'messageCount':{'type':Number,'default':0x0}}),Message=_0x194d65[_0x3f95a2(0x72)](_0x3f95a2(0xb0),messageSchema),rollSchema=new _0x194d65[(_0x3f95a2(0x75))]({'winner':{'type':String,'required':!![]},'prize':{'type':Number,'required':!![]},'timestamp':{'type':Date,'default':Date[_0x3f95a2(0x8e)]},'serverSeed':{'type':String,'required':!![]},'clientSeed':{'type':String,'required':!![]},'nonce':{'type':Number,'required':!![]},'hash':{'type':String,'required':!![]}}),Roll=_0x194d65[_0x3f95a2(0x72)](_0x3f95a2(0xa0),rollSchema);let lastSeenMessageId=null;const userLastMessages=new Map(),IGNORED_USERS=[_0x3f95a2(0xb3),_0x3f95a2(0xa1)];let nextRollTime=null,rollInterval=null,serverSeed=generateServerSeed(),nonce=0x0;function generateServerSeed(){const _0x2cd4bc=_0x3f95a2;return Math['random']()['toString'](0x24)[_0x2cd4bc(0xa7)](0x2,0xf)+Math['random']()[_0x2cd4bc(0x9a)](0x24)['substring'](0x2,0xf);}async function sha256(_0x1e090e){const _0x3113cd=_0x3f95a2;return _0x2bc7b2[_0x3113cd(0xcd)]('sha256')[_0x3113cd(0xb8)](_0x1e090e)[_0x3113cd(0x71)](_0x3113cd(0x81));}async function generateRoll(_0x3fc15d,_0x422d93,_0x317aa2){const _0x189544=_0x3f95a2,_0xcccea4=_0x3fc15d+'-'+_0x422d93+'-'+_0x317aa2,_0x394dfc=await sha256(_0xcccea4);return parseInt(_0x394dfc[_0x189544(0xa7)](0x0,0x8),0x10)/Math['pow'](0x2,0x20);}function getNextRollTime(){return getNextResetDate();}async function performRoll(){const _0x18289a=_0x3f95a2;try{const _0x428ca9=await Message[_0x18289a(0xa6)]()['sort']({'messageCount':-0x1})['limit'](0xa)[_0x18289a(0x91)]();if(_0x428ca9['length']===0x0){console['log'](_0x18289a(0xc6));return;}const _0x5cdb07=Date[_0x18289a(0x8e)]()[_0x18289a(0x9a)](),_0x1ccb76=await generateRoll(serverSeed,_0x5cdb07,nonce),_0x153b5b=Math[_0x18289a(0xb6)](_0x1ccb76*_0x428ca9['length']),_0x5d7ac7=_0x428ca9[_0x153b5b],_0x2b2293=new Roll({'winner':_0x5d7ac7[_0x18289a(0xc3)],'prize':0xa,'serverSeed':serverSeed,'clientSeed':_0x5cdb07,'nonce':nonce,'hash':await sha256(serverSeed+'-'+_0x5cdb07+'-'+nonce)});await _0x2b2293['save'](),console['log'](_0x18289a(0x88)+_0x5d7ac7[_0x18289a(0xc3)]+_0x18289a(0x9b)),nonce++,nextRollTime=getNextRollTime();}catch(_0x2d50e4){console[_0x18289a(0xb2)](_0x18289a(0x7d),_0x2d50e4);}}function getNextResetDate(){const _0xc066fe=_0x3f95a2,_0x59124f=new Date();let _0x11140d=new Date(_0x59124f[_0xc066fe(0xa9)](),0x6,0x1,0x0,0x0,0x0,0x0);return _0x59124f>_0x11140d&&(_0x11140d=new Date(_0x59124f[_0xc066fe(0xa9)]()+0x1,0x6,0x1,0x0,0x0,0x0,0x0)),_0x11140d;}function getTimeUntilReset(){const _0x4db01f=_0x3f95a2,_0x3604e6=new Date(),_0xf43536=getNextResetDate(),_0xc20cac=_0xf43536[_0x4db01f(0x97)]()-_0x3604e6[_0x4db01f(0x97)]();return Math[_0x4db01f(0x86)](0x0,_0xc20cac);}async function resetLeaderboard(){const _0xb763a7=_0x3f95a2;try{await Message['deleteMany']({}),await Roll[_0xb763a7(0x73)]({}),lastSeenMessageId=null,userLastMessages[_0xb763a7(0xc0)](),serverSeed=generateServerSeed(),nonce=0x0,nextRollTime=getNextRollTime(),console['log'](_0xb763a7(0x9f));}catch(_0x1af9ae){console[_0xb763a7(0xb2)]('Error\x20resetting\x20leaderboard:',_0x1af9ae);}}app[_0x3f95a2(0xc2)]('/timer',(_0xce35bc,_0x3dc113)=>{const _0x8a3e15=_0x3f95a2,_0x2550a3=getTimeUntilReset(),_0x4071cc=Math[_0x8a3e15(0xb6)](_0x2550a3/(0x3e8*0x3c*0x3c*0x18)),_0x298f10=Math[_0x8a3e15(0xb6)](_0x2550a3%(0x3e8*0x3c*0x3c*0x18)/(0x3e8*0x3c*0x3c)),_0x338778=Math[_0x8a3e15(0xb6)](_0x2550a3%(0x3e8*0x3c*0x3c)/(0x3e8*0x3c)),_0xebe81a=Math[_0x8a3e15(0xb6)](_0x2550a3%(0x3e8*0x3c)/0x3e8);_0x3dc113[_0x8a3e15(0x76)]({'timeLeft':_0x2550a3,'days':_0x4071cc,'hours':_0x298f10,'minutes':_0x338778,'seconds':_0xebe81a,'nextReset':getNextResetDate()[_0x8a3e15(0x7b)]()});}),app[_0x3f95a2(0xc2)]('/roll-info',async(_0x29f1a0,_0x2a8c69)=>{const _0x4f3def=_0x3f95a2;try{const _0x3b5221=getTimeUntilReset(),_0x28e15b=await Roll[_0x4f3def(0xad)]()[_0x4f3def(0xac)]({'timestamp':-0x1});_0x2a8c69[_0x4f3def(0x76)]({'nextRollTime':getNextResetDate()[_0x4f3def(0x7b)](),'timeUntilRoll':Math[_0x4f3def(0x86)](0x0,_0x3b5221),'latestRoll':_0x28e15b?{'winner':_0x28e15b[_0x4f3def(0x7e)],'prize':_0x28e15b[_0x4f3def(0x9d)],'timestamp':_0x28e15b[_0x4f3def(0xc1)],'hash':_0x28e15b[_0x4f3def(0x78)]}:null});}catch(_0x237b2b){_0x2a8c69[_0x4f3def(0x8d)](0x1f4)['json']({'error':_0x237b2b[_0x4f3def(0xbb)]});}}),app[_0x3f95a2(0xc2)](_0x3f95a2(0x74),async(_0x5eea54,_0x375d65)=>{const _0x599c07=_0x3f95a2;try{const _0x5c1b10=await Roll[_0x599c07(0xa6)]()['sort']({'timestamp':-0x1})[_0x599c07(0xa5)](0xa);_0x375d65[_0x599c07(0x76)](_0x5c1b10['map'](_0x1b7493=>({'winner':_0x1b7493['winner'],'prize':_0x1b7493[_0x599c07(0x9d)],'timestamp':_0x1b7493['timestamp'],'hash':_0x1b7493[_0x599c07(0x78)]})));}catch(_0x1e5e49){_0x375d65[_0x599c07(0x8d)](0x1f4)[_0x599c07(0x76)]({'error':_0x1e5e49[_0x599c07(0xbb)]});}}),app[_0x3f95a2(0xc2)](_0x3f95a2(0xc9),(_0x4a612c,_0x289b37)=>{const _0x542db5=_0x3f95a2;_0x289b37[_0x542db5(0x76)]({'serverSeed':serverSeed,'nextRollTime':nextRollTime?nextRollTime[_0x542db5(0x7b)]():null});});function isSpamMessage(_0x16c657,_0x39a1c8,_0x11f4ee){const _0xd054e9=_0x3f95a2,_0x37e2f9=_0x39a1c8[_0xd054e9(0x80)]();if(!_0x37e2f9)return!![];if(/^\[emote:\d+:[^\]]+\]$/[_0xd054e9(0x85)](_0x37e2f9))return!![];if(_0x37e2f9['length']<=0x2)return!![];const _0x176e2c=_0x37e2f9['replace'](/[^A-Za-z]/g,'');if(_0x176e2c['length']>=0x6){const _0x281705=(_0x176e2c['match'](/[A-Z]/g)||[])[_0xd054e9(0xb5)];if(_0x281705/_0x176e2c[_0xd054e9(0xb5)]>0.8)return!![];}const _0x4ece8c=userLastMessages[_0xd054e9(0xc2)](_0x16c657);if(_0x4ece8c){if(_0x4ece8c[_0xd054e9(0x8f)]===_0x37e2f9)return!![];if(similarity(_0x4ece8c[_0xd054e9(0x8f)],_0x37e2f9)>0.9)return!![];if(_0x11f4ee-_0x4ece8c['timestamp']<0x3e8)return!![];}return userLastMessages[_0xd054e9(0x7f)](_0x16c657,{'content':_0x37e2f9,'timestamp':_0x11f4ee}),![];}function similarity(_0x5b1925,_0x16953b){const _0x3a52d6=_0x3f95a2,_0x432aab=new Set(_0x5b1925['toLowerCase']()[_0x3a52d6(0xca)](/\s+/)),_0x1b2a0d=new Set(_0x16953b[_0x3a52d6(0xcc)]()['split'](/\s+/)),_0x47d896=new Set([..._0x432aab]['filter'](_0x317c3a=>_0x1b2a0d[_0x3a52d6(0xa3)](_0x317c3a)));return _0x47d896[_0x3a52d6(0x8a)]/Math[_0x3a52d6(0x86)](_0x432aab[_0x3a52d6(0x8a)],_0x1b2a0d[_0x3a52d6(0x8a)]);}function _0x1706(){const _0x2bf8de=['json','https://kick.com/api/v1/channels/enjayy','hash','62682wkHBxj','livestream','toISOString','save','Error\x20performing\x20roll:','winner','set','trim','hex','data','1183441flgvCf','messageCount','test','max','Mozilla/5.0','Roll\x20completed!\x20Winner:\x20','8cECOvs','size','1485854','Next\x20roll\x20scheduled\x20for:\x20','status','now','content','PORT','lean','static','Error\x20in\x20pollKickMessages:','schedule','https://kick.com/api/v2/channels/','sender','getTime','288390pYQTvu','20VnGLZk','toString',',\x20Prize:\x20$10','map','prize','/live-status','Leaderboard\x20reset\x20-\x207\x20day\x20cycle\x20completed','Roll','KickBot','post','has','connect','limit','find','substring','is_live','getFullYear','includes','*\x20*\x20*\x20*\x20*','sort','findOne','log','text','Message','messages','error','BotRix','149220zXzkwf','length','floor','668583jCCzYb','update','env','findOneAndUpdate','message','4319910gYpbdj','manual','Server\x20on\x20port\x20','443898fEzHFi','clear','timestamp','get','username','Live\x20check\x20failed:','/messages','No\x20users\x20available\x20for\x20roll','use','public','/current-seed','split','created_at','toLowerCase','createHash','digest','model','deleteMany','/roll-history','Schema'];_0x1706=function(){return _0x2bf8de;};return _0x1706();}app[_0x3f95a2(0xc2)]('/leaderboard',async(_0x211d65,_0x43706)=>{const _0x3aaf22=_0x3f95a2,_0x52f0ed=await Message['find']()[_0x3aaf22(0xac)]({'messageCount':-0x1})[_0x3aaf22(0xa5)](0x64)[_0x3aaf22(0x91)]();_0x43706[_0x3aaf22(0x76)](_0x52f0ed[_0x3aaf22(0x9c)](_0x506f44=>({'username':_0x506f44[_0x3aaf22(0xc3)],'messageCount':_0x506f44[_0x3aaf22(0x84)]})));}),app[_0x3f95a2(0xc2)](_0x3f95a2(0x9e),async(_0x2b48d9,_0x4304ca)=>{const _0x545eb4=_0x3f95a2;try{const _0x195fe5=await isStreamerLive();_0x4304ca[_0x545eb4(0x76)]({'isLive':_0x195fe5});}catch(_0x22ce17){_0x4304ca[_0x545eb4(0x8d)](0x1f4)[_0x545eb4(0x76)]({'error':_0x22ce17[_0x545eb4(0xbb)]});}});async function isStreamerLive(){const _0x530bb3=_0x3f95a2;try{const _0x115ae3=await _0x2b6fc5(_0x530bb3(0x77));if(!_0x115ae3['ok'])return![];const _0x52d086=await _0x115ae3[_0x530bb3(0x76)]();return _0x52d086['livestream']&&_0x52d086[_0x530bb3(0x7a)][_0x530bb3(0xa8)];}catch(_0x10a88a){return console[_0x530bb3(0xb2)](_0x530bb3(0xc4),_0x10a88a[_0x530bb3(0xbb)]),![];}}async function pollKickMessages(){const _0x4259a0=_0x3f95a2;try{const _0x37b86f=await isStreamerLive();if(!_0x37b86f){console[_0x4259a0(0xae)]('Streamer\x20is\x20offline\x20—\x20skipping\x20message\x20polling.');return;}const _0x2640dd=_0x4259a0(0x95)+CHANNEL_ID+_0x4259a0(0xc5),_0x1be7c5=await _0x2b6fc5(_0x2640dd,{'headers':{'User-Agent':'Mozilla/5.0'}});if(!_0x1be7c5['ok']){console[_0x4259a0(0xb2)]('Fetch\x20failed',await _0x1be7c5[_0x4259a0(0xaf)]());return;}const _0x552819=await _0x1be7c5[_0x4259a0(0x76)](),_0x38a3f9=(_0x552819[_0x4259a0(0x82)]?.[_0x4259a0(0xb1)]||[])['sort']((_0x5d1f43,_0x4d10db)=>new Date(_0x5d1f43[_0x4259a0(0xcb)])-new Date(_0x4d10db[_0x4259a0(0xcb)]));for(const _0x4e7195 of _0x38a3f9){if(lastSeenMessageId===_0x4e7195['id'])break;const _0x3b11bf=_0x4e7195[_0x4259a0(0x96)]?.[_0x4259a0(0xc3)],_0x25a042=_0x4e7195[_0x4259a0(0x8f)],_0x50180f=new Date(_0x4e7195[_0x4259a0(0xcb)])[_0x4259a0(0x97)]();if(!_0x3b11bf||!_0x25a042)continue;if(IGNORED_USERS[_0x4259a0(0xaa)](_0x3b11bf))continue;if(isSpamMessage(_0x3b11bf,_0x25a042,_0x50180f))continue;await Message[_0x4259a0(0xba)]({'username':_0x3b11bf},{'$inc':{'messageCount':0x1}},{'upsert':!![]});}_0x38a3f9[_0x4259a0(0xb5)]&&(lastSeenMessageId=_0x38a3f9[_0x38a3f9[_0x4259a0(0xb5)]-0x1]['id']);}catch(_0x7e7d84){console['error'](_0x4259a0(0x93),_0x7e7d84[_0x4259a0(0xbb)]);}}((async()=>{const _0x1ef7a4=_0x3f95a2;try{const _0x286431=await _0x2b6fc5('https://kick.com/api/v2/channels/'+CHANNEL_ID+'/messages',{'headers':{'User-Agent':_0x1ef7a4(0x87)}}),_0x4d3689=await _0x286431[_0x1ef7a4(0x76)](),_0x5b76ea=_0x4d3689[_0x1ef7a4(0x82)]?.[_0x1ef7a4(0xb1)]||[];_0x5b76ea[_0x1ef7a4(0xb5)]&&(lastSeenMessageId=_0x5b76ea[_0x5b76ea['length']-0x1]['id']);}catch(_0x5f66a4){}setInterval(pollKickMessages,0x3e8);})()),_0x595b89[_0x3f95a2(0x94)](_0x3f95a2(0xab),async()=>{const _0x1571b1=getTimeUntilReset();_0x1571b1===0x0&&(await resetLeaderboard(),await performRoll());}),((async()=>{const _0x5a77ac=_0x3f95a2;nextRollTime=getNextRollTime(),console['log'](_0x5a77ac(0x8c)+nextRollTime);})()),app[_0x3f95a2(0xc7)](_0x608ea5[_0x3f95a2(0x92)](_0x3f95a2(0xc8))),app['use'](_0x608ea5[_0x3f95a2(0x76)]()),app[_0x3f95a2(0xa2)]('/roll-winner',async(_0x5b7dff,_0x3f564a)=>{const _0x4138e8=_0x3f95a2;try{const {winner:_0x3c272c,prize:_0x42ff5f,timestamp:_0xfe86d0}=_0x5b7dff['body'],_0x5544b0=new Roll({'winner':_0x3c272c,'prize':_0x42ff5f,'timestamp':_0xfe86d0?new Date(_0xfe86d0):new Date(),'serverSeed':_0x4138e8(0xbd),'clientSeed':'manual','nonce':0x0,'hash':_0x4138e8(0xbd)});await _0x5544b0[_0x4138e8(0x7c)](),_0x3f564a[_0x4138e8(0x76)]({'success':!![]});}catch(_0x49d7a8){_0x3f564a['status'](0x1f4)[_0x4138e8(0x76)]({'error':_0x49d7a8[_0x4138e8(0xbb)]});}}),app['listen'](PORT,()=>console['log'](_0x3f95a2(0xbe)+PORT));
